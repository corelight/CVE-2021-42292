module CVE202142292;

export {
    type Info: record {
        ## Set to true if this connection is Sharepoint, and therefore a false positive.
        is_sharepoint: bool &default=F;
        ## Set to true if this connection has a UA for MS Office or Excel.
        ua_found: bool &default=F;
        ## Set to true if this connection has a MIME type for MS Excel.
        mime_found: bool &default=F;
    };
}

redef enum Notice::Type += {
    CVE_2021_42292,
    };

redef record connection += {
    CVE_2021_42292: Info &optional;
};

function set_session(c: connection)
    {
    if ( ! c?$CVE_2021_42292 )
        {
        c$CVE_2021_42292 = [$is_sharepoint=F, $ua_found=F, $mime_found=F];
        }
    }

event http_all_headers(c: connection, is_orig: bool, hlist: mime_header_list)
    {
    for (i in hlist)
        {
        if (hlist[i]$name == "USER-AGENT" && hlist[i]$value == /^(Microsoft Office.*Excel.*|Mozilla.*ms-office.*)/)
            {
            set_session(c);
            c$CVE_2021_42292$ua_found = T;
            next;
            }
        if (hlist[i]$name == "CONTENT-TYPE" && hlist[i]$value == /^(application\/vnd\.openxmlformats-officedocument\.spreadsheetml\.sheet|application\/vnd\.ms-excel).*/)
            {
            set_session(c);
            c$CVE_2021_42292$mime_found = T;
            next;
            }
        if (hlist[i]$name == "MICROSOFTSHAREPOINTTEAMSERVICES")
            {
            set_session(c);
            c$CVE_2021_42292$is_sharepoint = T;
            next;
            }
        }
    }

event connection_state_remove(c: connection)
    {
    if (!c?$CVE_2021_42292 || c$CVE_2021_42292$ua_found == F || c$CVE_2021_42292$mime_found == F || c$CVE_2021_42292$is_sharepoint == T)
        return;

    NOTICE([$note=CVE_2021_42292,
            $conn=c,
            $msg=fmt("%s may be compromised by CVE-2021-42292, MS Office Excel download using Office from %s detected.", c$id$orig_h, c$id$orig_h),
            $src=c$id$orig_h,
            $identifier=cat(c$id$orig_h)]);
    }